global
        daemon
        maxconn         256
        user            root
        group           root
        # log 127.0.0.1 local0 debug

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        retries 3
        option redispatch
        option http-server-close
        option forwardfor
        maxconn 2000
        timeout connect 5s
        timeout client  15m
        timeout server  15m

frontend ingress
        bind *:8099
        acl NETWORK_ALLOWED src 172.30.32.2
        http-request set-header X-Forwarded-For 172.30.32.2 if NETWORK_ALLOWED
        default_backend backend_octoprint_ingress

frontend web
        bind *:5000
        default_backend backend_octoprint

frontend camera
        bind *:8000
        default_backend backend_camera

backend backend_octoprint
        option forwardfor
        server octoprint1 127.0.0.1:80

backend backend_octoprint_ingress
        http-request replace-path ^([^\ :]*)\ %%ingress_entry%%/(.*)  \1\ /\2
        http-request add-header X-Script-Name %[req.hdr(X-Ingress-Path)]
        option forwardfor
        server octoprint1 127.0.0.1:80

backend backend_octoprint
        option forwardfor
        server octoprint1 127.0.0.1:80

backend backend_camera
        server webcam1 127.0.0.1:8080
